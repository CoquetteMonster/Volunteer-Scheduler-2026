<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Volunteer Scheduler (Cloud)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#f5f7fa; padding:20px; }
.container { max-width:900px; margin:auto; background:white; padding:20px; border-radius:10px; }
input,button{ padding:8px; margin:5px 0; width:100%; }
button{ background:#4CAF50; color:white; border:none; cursor:pointer; }
button:hover{ background:#45a049; }
#output{ background:#eef; padding:10px; height:220px; overflow:auto; white-space:pre-line; }
</style>
</head>

<body>

<div class="container">

<h2>Volunteer Scheduler (Cloud Saving)</h2>

<label>Upload Volunteers CSV:</label>
<input type="file" id="csvFile" accept=".csv">

<label>Event Name:</label>
<input type="text" id="eventName">

<label>Start Time (hour):</label>
<input type="number" id="startTime">

<label>Duration (hours):</label>
<input type="number" id="duration">

<label>Volunteers Needed:</label>
<input type="number" id="required">

<button onclick="allocate()">Allocate Volunteers</button>
<button onclick="resetAllocations()">Reset Allocations</button>
<button onclick="showGantt()">Show Gantt Chart</button>
<button onclick="showLogs()">Show Log History</button>

<h3>Output</h3>
<div id="output"></div>

<canvas id="chart"></canvas>

</div>

<script type="module">

// ================= FIREBASE =================

import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore, doc, setDoc, getDoc
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCp_jicOjV9UWyPCYlq6Cndoml5TG417RI",
  authDomain: "volunteer-scheduler-1.firebaseapp.com",
  projectId: "volunteer-scheduler-1",
  storageBucket: "volunteer-scheduler-1.firebasestorage.app",
  messagingSenderId: "274672009119",
  appId: "1:274672009119:web:879856a7fb9939386cc7aa",
  measurementId: "G-5D064DBWMN"
};


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= DATA =================

let volunteers = [];
let logs = [];
let chart = null;

// ================= CSV LOADING =================

document.getElementById("csvFile").addEventListener("change", e => {

  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = evt => {

    const lines = evt.target.result.trim().split("\n");
    volunteers = [];

    for (let i = 1; i < lines.length; i++) {

      const cols = lines[i].split(",");
      const reg_no = cols[0]?.trim();
      const name = cols[1]?.trim() || "Unknown";

      if (reg_no) {
        volunteers.push({
          reg_no,
          name,
          next_available: 0,
          tasks: []
        });
      }
    }

    logAction(`Loaded ${volunteers.length} volunteers`);
  };

  reader.readAsText(file);
});

// ================= LOGGING =================

async function logAction(message) {

  const entry =
    `[${new Date().toLocaleString()}] ${message}`;

  logs.push(entry);

  document.getElementById("output").innerText = entry;

  try {
    await setDoc(doc(db, "scheduler", "main"), {
      volunteers,
      logs
    });
  } catch (err) {
    alert("Firebase save failed. Check Firestore rules.");
    console.error(err);
  }
}

// ================= LOAD FROM CLOUD =================

async function loadFromCloud() {

  try {
    const snap = await getDoc(doc(db, "scheduler", "main"));

    if (snap.exists()) {

      const data = snap.data();

      volunteers = data.volunteers || [];
      logs = data.logs || [];

      if (logs.length > 0)
        document.getElementById("output").innerText =
          logs[logs.length - 1];
    }
  } catch (err) {
    console.error("Cloud load failed", err);
  }
}

// ================= ALLOCATION =================

window.allocate = function() {

  if (volunteers.length === 0) {
    alert("Please upload volunteers CSV first.");
    return;
  }

  const eventName =
    document.getElementById("eventName").value.trim();

  const start =
    parseInt(document.getElementById("startTime").value) || 0;

  const duration =
    parseInt(document.getElementById("duration").value) || 0;

  const required =
    parseInt(document.getElementById("required").value) || 0;

  if (!eventName || duration <= 0 || required <= 0) {
    alert("Please fill all event details correctly.");
    return;
  }

  let assigned = 0;
  let result =
    `Assigned Volunteers for '${eventName}':\n`;

  for (let v of volunteers) {

    if (assigned >= required) break;

    if (v.next_available <= start) {

      const work = Math.min(duration, 2);
      const end = start + work;

      v.next_available = end + 1;

      v.tasks.push({ start, duration: work, event: eventName });

      result += `${v.reg_no} — ${v.name}\n`;
      assigned++;
    }
  }

  if (assigned < required)
    result += "⚠ Not enough volunteers available!";

  logAction(result);
};

// ================= RESET =================

window.resetAllocations = function() {

  if (volunteers.length === 0) {
    alert("No volunteers loaded.");
    return;
  }

  volunteers.forEach(v => {
    v.next_available = 0;
    v.tasks = [];
  });

  if (chart) {
    chart.destroy();
    chart = null;
  }

  logAction("Allocations reset");
};

// ================= SHOW LOGS =================

window.showLogs = function() {

  if (logs.length === 0) {
    alert("No logs available.");
    return;
  }

  document.getElementById("output").innerText =
    logs.join("\n\n");
};

// ================= GANTT =================

window.showGantt = function() {

  const datasets = [];

  volunteers.forEach(v => {
    v.tasks.forEach(t => {
      datasets.push({
        label: `${v.name} (${v.reg_no})`,
        data: [{
          x: [t.start, t.start + t.duration],
          y: `${v.name} (${v.reg_no})`
        }]
      });
    });
  });

  if (datasets.length === 0) {
    alert("No allocations to display.");
    return;
  }

  const ctx = document.getElementById("chart").getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: { datasets },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display:false } }
    }
  });
};

// ================= STARTUP =================

loadFromCloud();

</script>

</body>
</html>
